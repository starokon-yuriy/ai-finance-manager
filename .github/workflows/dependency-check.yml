name: Dependency Check

on:
  schedule:
    # Run every Monday at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'ai-finance-manager/pom.xml'
      - 'ai-finance-manager/frontend/package.json'
      - 'ai-finance-manager/frontend/package-lock.json'

jobs:
  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ai-finance-manager

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Check for Maven dependency updates
        run: |
          echo "## Maven Dependency Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          mvn versions:display-dependency-updates | tee maven-updates.txt

          if grep -q "No dependencies in Dependencies have newer versions" maven-updates.txt; then
            echo "✅ All Maven dependencies are up to date" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Maven dependencies have updates available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Check for Maven plugin updates
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Maven Plugin Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          mvn versions:display-plugin-updates | tee maven-plugin-updates.txt

          if grep -q "All plugins have a version specified" maven-plugin-updates.txt; then
            echo "✅ All Maven plugins are properly versioned" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Maven Dependency Tree
        run: mvn dependency:tree -DoutputFile=maven-dependency-tree.txt

      - name: Upload Maven Dependency Reports
        uses: actions/upload-artifact@v4
        with:
          name: maven-dependency-reports
          path: |
            ai-finance-manager/maven-updates.txt
            ai-finance-manager/maven-plugin-updates.txt
            ai-finance-manager/maven-dependency-tree.txt

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ai-finance-manager/frontend/package-lock.json

      - name: Install Frontend Dependencies
        working-directory: ai-finance-manager/frontend
        run: npm ci

      - name: Run npm audit
        working-directory: ai-finance-manager/frontend
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## NPM Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          npm audit --audit-level=moderate || {
            echo "⚠️ NPM audit found vulnerabilities" >> $GITHUB_STEP_SUMMARY
            echo "Run 'npm audit fix' to resolve" >> $GITHUB_STEP_SUMMARY
          }

      - name: Check for npm outdated packages
        working-directory: ai-finance-manager/frontend
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## NPM Outdated Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          npm outdated > npm-outdated.txt || true

          if [ -s npm-outdated.txt ]; then
            echo "⚠️ Some NPM packages have updates available" >> $GITHUB_STEP_SUMMARY
            cat npm-outdated.txt
          else
            echo "✅ All NPM packages are up to date" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload NPM Dependency Reports
        uses: actions/upload-artifact@v4
        with:
          name: npm-dependency-reports
          path: ai-finance-manager/frontend/npm-outdated.txt

  owasp-dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@v3.0.0
        with:
          project: 'ai-finance-manager'
          path: '.'
          format: 'HTML'
          args: >
            --failOnCVSS 7
            --enableRetired

      - name: Upload OWASP Dependency Check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports/

